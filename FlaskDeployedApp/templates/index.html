<html>
{% extends 'base.html' %}

{% block pagetitle %}
AI Engine
{% endblock pagetitle %}

{% block body %}
    <!-- Hero Section -->
    <section class="hero-section">
        <div class="container text-center">
            <h1 class="hero-title">ğŸ€ Yapay Zeka ğŸ€</h1>
            <p class="hero-subtitle">HastalÄ±klarÄ± Tespit Etmenize YardÄ±mcÄ± Olur</p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container mb-5">
        <div class="row g-4">
            <!-- Left Column: Why Plant Disease Detection is Important -->
            <div class="col-md-4">
                <div class="content-card">
                    <h5>Bitkilerde hastalÄ±k tespiti neden gereklidir?</h5>
                    <p>Bitki hastalÄ±klarÄ±, kendi tÃ¼rlerinin bÃ¼yÃ¼mesini etkiler. Ek olarak, belirtiler ortaya Ã§Ä±kmadan Ã¶nce
                        hastalÄ±klarÄ± tespit etmek iÃ§in araÅŸtÄ±rmalar yapÄ±lmaktadÄ±r. TanÄ±, bitki patoloÄŸunun en Ã¶nemli
                        gÃ¶revidir. YanlÄ±ÅŸ teÅŸhis zaman ve para kaybÄ±na yol aÃ§abilir.</p>
                </div>
            </div>
            
            <!-- Middle Column: File Upload Section -->
            <div class="col-md-4">
                <div class="content-card">
                    <div class="upload-area">
                        <div class="preview-container">
                            <img id="preview-image" 
                                src="{{ url_for('static', filename='preview.png') }}"
                                alt="Preview" class="preview-image">
                        </div>
                        
                        <!-- File Upload Form -->
                        <form action="/submit" method="POST" enctype="multipart/form-data" class="w-100">
                            <div class="file-upload-container">
                                <input type="file" id="actual-btn" hidden name="image" accept="image/*" onchange="previewFile()" />
                                <label for="actual-btn" class="file-upload-label">
                                    <i class="fas fa-upload me-2"></i>Dosya SeÃ§in
                                </label>
                                <span id="file-chosen" class="file-name">HiÃ§bir dosya seÃ§ilmedi</span>
                            </div>
                            
                            <p class="text-center mb-4 text-muted">
                                Bitkinizin yaprak gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ yÃ¼kleyin ve yapay zekanÄ±n bÃ¼yÃ¼sÃ¼nÃ¼ gÃ¶rÃ¼n.
                            </p>
                            
                            <div class="d-flex flex-column align-items-center gap-3">
                                <!-- Camera Button -->
                                <button type="button" class="btn btn-primary w-100" onclick="openCamera()">
                                    <i class="fas fa-camera me-2"></i>Kamera ile Ã‡ek
                                </button>
                                
                                <!-- Video and Canvas Elements -->
                                <video id="camera" width="100%" height="auto" autoplay style="display:none;"></video>
                                <canvas id="canvas" style="display:none;"></canvas>
                                
                                <!-- Capture Button -->
                                <button type="button" class="btn btn-danger w-100" id="capture-btn" style="display:none;" onclick="captureImage()">
                                    <i class="fas fa-camera me-2"></i>FotoÄŸraf Ã‡ek
                                </button>
                                
                                <!-- Confirm Button -->
                                <button type="button" class="btn btn-success w-100" id="confirm-btn" style="display:none;" onclick="uploadCapturedImage()">
                                    <i class="fas fa-check me-2"></i>Onayla ve GÃ¶nder
                                </button>
                                
                                <!-- Submit Button -->
                                <button type="submit" class="btn btn-success w-100" id="submit-btn" disabled>
                                    <i class="fas fa-upload me-2"></i>Dosya YÃ¼kle
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Steps to Prevent Plant Diseases -->
            <div class="col-md-4">
                <div class="content-card">
                    <h5>Bitki HastalÄ±klarÄ±nÄ± Ã–nlemek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:</h5>
                    <ol class="ps-3 mb-4">
                        <li class="mb-2">Ä°yi Hijyen UygulamalarÄ±nÄ± Takip Edin</li>
                        <li class="mb-2">Bitkilerinizin SaÄŸlÄ±klÄ± KalmasÄ± Ä°Ã§in GÃ¼breleyin</li>
                        <li class="mb-2">Bitkileri Eve Getirmeden Ã–nce HastalÄ±klara KarÅŸÄ± Kontrol Edin</li>
                        <li class="mb-2">Dikimden Ã–nce TopraÄŸÄ±n IsÄ±nmasÄ±nÄ± SaÄŸlayÄ±n</li>
                        <li class="mb-2">ÃœrÃ¼n Rotasyonu Yaparak SaÄŸlÄ±klÄ± Bir BahÃ§e SaÄŸlayÄ±n</li>
                        <li class="mb-2">Ä°yi Hava SirkÃ¼lasyonu SaÄŸlayÄ±n</li>
                        <li class="mb-2">HastalÄ±klÄ± GÃ¶vdeleri ve YapraklarÄ± Temizleyin</li>
                    </ol>
                    <div class="text-center">
                        <a target="_blank" 
                           href="https://coolconceptflower.com/blog/evde-bitki-hastaliklari--tani--tedavi-ve-onleme-yollari?srsltid=AfmBOoo9md8pTv_juWL5bZBCDb9jjTeqzBQQbjE4r-Q8h3jaZOZor-6C" 
                           class="btn btn-outline-success">
                            <i class="fas fa-info-circle me-2"></i>Daha Fazla Bilgi
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- JavaScript -->
<script>
    document.getElementById('actual-btn').addEventListener('change', function () {
        let fileChosen = document.getElementById('file-chosen');
        let submitBtn = document.getElementById('submit-btn');  // YÃ¼kle butonunu al

        if (this.files.length > 0) {
            fileChosen.textContent = this.files[0].name;
            submitBtn.disabled = false;  // Dosya seÃ§ildiÄŸinde butonu etkinleÅŸtir
        } else {
            fileChosen.textContent = "HiÃ§bir dosya seÃ§ilmedi";
            submitBtn.disabled = true;  // Dosya seÃ§ilmediyse butonu devre dÄ±ÅŸÄ± bÄ±rak
        }
    });

    function openCamera() {
        const video = document.getElementById("camera");
        const captureBtn = document.getElementById("capture-btn");
        const submitBtn = document.getElementById("submit-btn");

        // Kamera aÃ§Ä±ldÄ±ÄŸÄ±nda YÃ¼kle butonunu gizle
        submitBtn.style.display = "none";

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.style.display = "block";
                captureBtn.style.display = "block";
            })
            .catch(err => {
                alert("Kamera eriÅŸimi reddedildi: " + err);
            });
    }

    function captureImage() {
        const video = document.getElementById("camera");
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageDataUrl = canvas.toDataURL("image/png");
        document.getElementById("preview-image").src = imageDataUrl;

        // Kamera durduruluyor
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = "none";
        document.getElementById("capture-btn").style.display = "none";

        // KullanÄ±cÄ±ya onay butonu gÃ¶ster
        document.getElementById("confirm-btn").style.display = "block";

        // FotoÄŸraf Ã§ekildikten sonra YÃ¼kle butonunu gizle
        const submitBtn = document.getElementById("submit-btn");
        submitBtn.style.display = "none";
    }

    function uploadCapturedImage() {
        const canvas = document.getElementById("canvas");

        // Canvas'taki gÃ¶rÃ¼ntÃ¼yÃ¼ Blob olarak al
        canvas.toBlob((blob) => {
            const file = new File([blob], "captured_image.png", { type: "image/png" });
            let formData = new FormData();
            formData.append("image", file);

            // AJAX isteÄŸi ile Flask backend'e gÃ¶nder
            fetch("/submit", {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Sunucu hatasÄ±!');
                    }
                    return response.text();  // HTML yanÄ±tÄ±nÄ± alÄ±yoruz
                })
                .then(html => {
                    // Gelen yanÄ±t HTML ise, sayfayÄ± yeni iÃ§erik ile deÄŸiÅŸtirelim
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(error => {
                    console.error("YÃ¼kleme hatasÄ±:", error);
                    alert("Bir hata oluÅŸtu.");
                });
        }, "image/png");
    }
</script>

{% endblock body %}