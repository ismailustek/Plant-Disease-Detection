<html>
{% extends 'base.html' %}

{% block pagetitle %}
AI Engine
{% endblock pagetitle %}

{% block body %}
<div>
    <div class="container">
        <!-- BaÅŸlÄ±k -->
        <div class="row mb-5 text-center text-white">
            <div class="col-lg-10 mx-auto">
                <h1 class="display-4" style="padding-top: 2%; font-weight: 400; color: rgb(4, 54, 4);">
                    <b>ğŸ€Yapay ZekağŸ€</b>
                </h1>
                <p class="lead" style="font-weight: 500; color: black;">HastalÄ±klarÄ± Tespit Etmenize YardÄ±mcÄ± Olur</p>
            </div>
        </div>

        <div class="row">
            <!-- AÃ§Ä±klama KÄ±smÄ± -->
            <div class="col mx-auto">
                <div class="p-5 bg-white shadow rounded-lg" style="height: 95%;">
                    <h5><b>Bitkilerde hastalÄ±k tespiti neden gereklidir?</b></h5>
                    <p>Bitki hastalÄ±klarÄ±, kendi tÃ¼rlerinin bÃ¼yÃ¼mesini etkiler. Ek olarak, belirtiler ortaya Ã§Ä±kmadan
                        Ã¶nce hastalÄ±klarÄ± tespit etmek iÃ§in araÅŸtÄ±rmalar yapÄ±lmaktadÄ±r. TanÄ±, bitki patoloÄŸunun en
                        Ã¶nemli gÃ¶revidir. YanlÄ±ÅŸ teÅŸhis zaman ve para kaybÄ±na yol aÃ§abilir.</p>
                </div>
            </div>

            <!-- Dosya SeÃ§me KÄ±smÄ± -->
            <div class="col mx-auto">
                <div class="p-5 bg-white shadow rounded-lg" style="height: 95%;">
                    <img id="preview-image"
                        src="https://www.pngjoy.com/pngl/250/4840262_plants-png-indoors-tropical-plant-png-hd-png.png"
                        height="300" alt="Preview" width="200" class="d-block mx-auto mb-4">

                    <!-- Dosya YÃ¼kleme Formu -->
                    <!-- <form action="/submit" method="POST" enctype="multipart/form-data">
                        <div class="custom-file overflow-hidden mb-4">
                            <input type="file" id="actual-btn" hidden name="image" accept="image/*" onchange="previewFile()" />
                            <label for="actual-btn" class="custom-file-label">Dosya SeÃ§in</label>
                            <br>
                            <span id="file-chosen">HiÃ§bir dosya seÃ§ilmedi</span>
                        </div>
            
                        <h6 class="text-center mb-4 text-muted">
                            Bitkinizin yaprak gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ yÃ¼kleyin ve yapay zekanÄ±n bÃ¼yÃ¼sÃ¼nÃ¼ gÃ¶rÃ¼n.
                        </h6>
            
                        <center>
                            <button type="button" class="btn btn-primary mb-3" onclick="openCamera()">Kamera ile Ã‡ek</button>
                            <video id="camera" width="224" height="224" autoplay style="display:none;"></video>
                            <canvas id="canvas" style="display:none;"></canvas>
                            <button type="button" class="btn btn-danger" id="capture-btn" style="display:none;" onclick="captureImage()">FotoÄŸraf Ã‡ek</button>
                            <button type="button" class="btn btn-success" id="confirm-btn" style="display:none;" onclick="uploadCapturedImage()">Onayla ve GÃ¶nder</button>
                        </center>
                        
                    </form> -->
                    <!-- Dosya YÃ¼kleme Formu -->
                    <form action="/submit" method="POST" enctype="multipart/form-data">
                        <div class="custom-file overflow-hidden mb-4">
                            <input type="file" id="actual-btn" hidden name="image" accept="image/*"
                                onchange="previewFile()" />
                            <label for="actual-btn" class="custom-file-label">Dosya SeÃ§in</label>
                            <br>
                            <span id="file-chosen">HiÃ§bir dosya seÃ§ilmedi</span>
                        </div>

                        <h6 class="text-center mb-4 text-muted">
                            Bitkinizin yaprak gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ yÃ¼kleyin ve yapay zekanÄ±n bÃ¼yÃ¼sÃ¼nÃ¼ gÃ¶rÃ¼n.
                        </h6>

                        <center>
                            <!-- Kamera ile Ã‡ek Butonu -->
                            <button type="button" class="btn btn-primary mb-3" onclick="openCamera()">Kamera ile
                                Ã‡ek</button>

                            <!-- Video ve Canvas AlanlarÄ± -->
                            <video id="camera" width="448" height="448" autoplay style="display:none;"></video>
                            <canvas id="canvas" style="display:none;"></canvas>

                            <!-- FotoÄŸraf Ã‡ek Butonu -->
                            <button type="button" class="btn btn-danger" id="capture-btn" style="display:none;"
                                onclick="captureImage()">FotoÄŸraf Ã‡ek</button>

                            <!-- Onayla ve GÃ¶nder Butonu -->
                            <button type="button" class="btn btn-success" id="confirm-btn" style="display:none;"
                                onclick="uploadCapturedImage()">Onayla ve GÃ¶nder</button>

                            <!-- YÃ¼kle Butonu (BaÅŸlangÄ±Ã§ta devre dÄ±ÅŸÄ±) -->
                            <button type="submit" class="btn btn-success mb-3" id="submit-btn" disabled>Dosya
                                YÃ¼kle</button>
                        </center>
                    </form>

                </div>
            </div>

            <!-- HastalÄ±k Ã–nleme AdÄ±mlarÄ± -->
            <div class="col mx-auto">
                <div class="p-5 bg-white shadow rounded-lg" style="height: 95%;">
                    <h5><b>Bitki HastalÄ±klarÄ±nÄ± Ã–nlemek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± izleyin:</b></h5>
                    <ol>
                        <li>Ä°yi Hijyen UygulamalarÄ±nÄ± Takip Edin</li>
                        <li>Bitkilerinizin SaÄŸlÄ±klÄ± KalmasÄ± Ä°Ã§in GÃ¼breleyin.</li>
                        <li>Bitkileri Eve Getirmeden Ã–nce HastalÄ±klara KarÅŸÄ± Kontrol Edin.</li>
                        <li>Dikimden Ã–nce TopraÄŸÄ±n IsÄ±nmasÄ±nÄ± SaÄŸlayÄ±n.</li>
                        <li>ÃœrÃ¼n Rotasyonu Yaparak SaÄŸlÄ±klÄ± Bir BahÃ§e SaÄŸlayÄ±n.</li>
                        <li>Ä°yi Hava SirkÃ¼lasyonu SaÄŸlayÄ±n</li>
                        <li>HastalÄ±klÄ± GÃ¶vdeleri ve YapraklarÄ± Temizleyin</li>
                    </ol>
                    <a target="_blank"
                        href="https://coolconceptflower.com/blog/evde-bitki-hastaliklari--tani--tedavi-ve-onleme-yollari?srsltid=AfmBOoo9md8pTv_juWL5bZBCDb9jjTeqzBQQbjE4r-Q8h3jaZOZor-6C"
                        class="mx-2">
                        <button type="button" class="btn btn-outline-success">Daha Fazla Bilgi</button>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stil -->
<style>
    .custom-file-label {
        display: inline-block;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
    }

    .custom-file-label:hover {
        background-color: #218838;
    }
</style>

<!-- JavaScript -->
<script>
    document.getElementById('actual-btn').addEventListener('change', function () {
        let fileChosen = document.getElementById('file-chosen');
        let submitBtn = document.getElementById('submit-btn');  // YÃ¼kle butonunu al

        if (this.files.length > 0) {
            fileChosen.textContent = this.files[0].name;
            submitBtn.disabled = false;  // Dosya seÃ§ildiÄŸinde butonu etkinleÅŸtir
        } else {
            fileChosen.textContent = "HiÃ§bir dosya seÃ§ilmedi";
            submitBtn.disabled = true;  // Dosya seÃ§ilmediyse butonu devre dÄ±ÅŸÄ± bÄ±rak
        }
    });

    function openCamera() {
        const video = document.getElementById("camera");
        const captureBtn = document.getElementById("capture-btn");
        const submitBtn = document.getElementById("submit-btn");

        // Kamera aÃ§Ä±ldÄ±ÄŸÄ±nda YÃ¼kle butonunu gizle
        submitBtn.style.display = "none";

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.style.display = "block";
                captureBtn.style.display = "block";
            })
            .catch(err => {
                alert("Kamera eriÅŸimi reddedildi: " + err);
            });
    }

    function captureImage() {
        const video = document.getElementById("camera");
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageDataUrl = canvas.toDataURL("image/png");
        document.getElementById("preview-image").src = imageDataUrl;

        // Kamera durduruluyor
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = "none";
        document.getElementById("capture-btn").style.display = "none";

        // KullanÄ±cÄ±ya onay butonu gÃ¶ster
        document.getElementById("confirm-btn").style.display = "block";

        // FotoÄŸraf Ã§ekildikten sonra YÃ¼kle butonunu yeniden gÃ¶sterebilirsiniz
        const submitBtn = document.getElementById("submit-btn");
        submitBtn.style.display = "inline-block";  // YÃ¼kle butonunu tekrar gÃ¶ster
    }

    function previewFile() {
        const file = document.getElementById("actual-btn").files[0];
        const reader = new FileReader();

        reader.onloadend = function () {
            document.getElementById("preview-image").src = reader.result;
        }

        if (file) {
            reader.readAsDataURL(file);
            document.getElementById("file-chosen").textContent = file.name;
        }
    }


    function uploadCapturedImage() {
        const canvas = document.getElementById("canvas");

        // Canvas'taki gÃ¶rÃ¼ntÃ¼yÃ¼ Blob olarak al
        canvas.toBlob((blob) => {
            const file = new File([blob], "captured_image.png", { type: "image/png" });
            let formData = new FormData();
            formData.append("image", file);

            // AJAX isteÄŸi ile Flask backend'e gÃ¶nder
            fetch("/submit", {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Sunucu hatasÄ±!');
                    }
                    return response.text();  // HTML yanÄ±tÄ±nÄ± alÄ±yoruz
                })
                .then(html => {
                    // Gelen yanÄ±t HTML ise, sayfayÄ± yeni iÃ§erik ile deÄŸiÅŸtirelim
                    document.open();
                    document.write(html);
                    document.close();
                })
                .catch(error => {
                    console.error("YÃ¼kleme hatasÄ±:", error);
                    alert("Bir hata oluÅŸtu.");
                });
        }, "image/png");
    }
</script>

{% endblock body %}